# this custom script in addition to MODE=nfqws runs desync to all QUIC initial packets, without ipset/hostlist filtering
# need to add to config : NFQWS_OPT_DESYNC_QUIC="--dpi-desync=fake"
# NOTE : do not use TTL fooling. chromium QUIC engine breaks sessions if TTL expired in transit received

QNUM2=$(($QNUM + 10))

zapret_custom_daemons() {
	# stop logic is managed by procd

	local MODE_OVERRIDE=nfqws
	local opt

	start_daemons_procd

	opt="--qnum=$QNUM2 $NFQWS_OPT_BASE $NFQWS_OPT_DESYNC_QUIC"
	run_daemon 100 "$NFQWS" "$opt"
}
zapret_custom_firewall() {
	# $1 - 1 - run, 0 - stop

	local MODE_OVERRIDE=nfqws
	local f
	local first_packets_only="$ipt_connbytes 1:3"
	local desync="-m mark ! --mark $DESYNC_MARK/$DESYNC_MARK"

	zapret_do_firewall_rules_ipt "$1"

	f="-p udp -m multiport --dports $QUIC_PORTS_IPT"
	fw_nfqws_post "$1" "$f $desync $first_packets_only" "$f $desync $first_packets_only" $QNUM2

}
zapret_custom_firewall_nft() {
	# stop logic is not required

	local MODE_OVERRIDE=nfqws
	local f
	local first_packets_only="$nft_connbytes 1-3"
	local desync="mark and $DESYNC_MARK == 0"

	zapret_apply_firewall_rules_nft

	f="udp dport {$QUIC_PORTS}"
	nft_fw_nfqws_post "$f $desync $first_packets_only" "$f $desync $first_packets_only" $QNUM2
}
